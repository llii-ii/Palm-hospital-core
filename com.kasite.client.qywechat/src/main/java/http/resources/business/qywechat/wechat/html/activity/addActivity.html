<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <meta name="apple-mobile-web-app-capable" content="yes">
	    <meta name="format-detection" content="telephone=no">
	    <meta name="type" content="app">
	    <title>新增活动</title>
	    <script src="../../js/rem.js" type="text/javascript" charset="utf-8"></script>
	    <link rel="stylesheet" type="text/css" href="../../css/common.css"/>
	    <link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
	    <link rel="stylesheet" type="text/css" href="../../css/mui.picker.min.css"/>
	    <link rel="stylesheet" type="text/css" href="../../css/base.css"/>
		<style type="text/css">
			.act3{
				line-height: 1.4;
				padding-bottom: 1rem;
			}
			.act3-form{
				padding: 0 0.4rem 0 0.25rem;
				background: #fff;
				margin-top: 0.12rem;
			}
			.act3-form li{
				position: relative;
			}
			.act3-form li:after{
				position: absolute;
				content: '';
				display: block;
				height: 0;
				left: -.25rem;
				right: -.4rem;
				bottom: 0;
				border-bottom: 1px solid #f2f4f5;
			}
			.act3-form li.noline:after{
				display: none;
			}
			.act3-form label{
				color: #191919;
				font-size: 0.3rem;
			}
			.act3-form label span{
				color: #ccc;
				padding-left: 0.1rem;
				font-size: 0.24rem;
			}
			.act3-form input{
				display: block;
				font-size: 0.3rem;
				line-height: 0.6rem;
				height: 0.6rem;
				padding: 0 .4rem 0 0.12rem;
				margin-top: 0.24rem;
				text-align: right;
				float: right;
			}
			.act3-form textarea{
				display: block;
				font-size: 0.3rem;
				line-height: 0.4rem;
				padding: 0 .4rem 0 0;
				width: 100%;
			}
			.act3-form .x-row{
				position: relative;
				line-height: 1rem;
			}
			.act3-form li:last-child:after{
				display: none;
			}
			.right-arrow{
				position: absolute;
				right: 0;
				top: 0.4rem;
				width: 0.13rem;
			}
			.imagelist-item{
				display: block;
				float: left;
				padding-right: 0.25rem;
				padding-bottom: 0.25rem;
			}
			.imagelist-item-img{
				width: 2rem;
				height: 2rem;
			}
			.imagelist-item-img img{
				width: 100%;
				height: 100%;
			}
			.imagelist-item-btn{
				position: relative;
				overflow: hidden;
			}
			.imagelist-item-btn:after{
				content: '';
				display: block;
				width: 2rem;
				height: 2rem;
				background-image: url(../../img/icon-vote-8.png);
				background-position: center;
				background-size: 0.7rem;
				background-repeat: no-repeat;
				border: 1px solid #f2f4f5;
			}
			.imagelist-item-btn input[type="file"]{
				position: absolute;
				left: 0;
				top: 0;
				right: 0;
				bottom: 0;
				z-index: 2;
				opacity: 0;
				height: auto;
				width: 100%;
			}
		</style>
	</head>
	<body>
		<div class="container">
	        <div class="act3">
	        	<ul class="act3-form">
	        		<li>
	        			<div class="x-row">
							<div class="x-row-cols " style="width: 2rem;"><label>标题<span style="color: red;">*</span></label></div>
							<div class="x-row-cols " style="margin-left:2rem;">
								<input type="text" id="title" placeholder="请输入标题" />
							</div>
						</div>
	        		</li>
	        		<li>
	        			<div class="x-row">
							<div class="x-row-cols " style="width: 2rem;"><label>参与人数<span style="color: red;">*</span></label></div>
							<div class="x-row-cols " style="margin-left:2rem;">
								<input type="number" id="partNumber" placeholder="请输入参与人数" />
							</div>
						</div>
	        		</li>
	        		<li>
	        			<div class="x-row">
							<div class="x-row-cols " style="width: 2rem;"><label>活动地点<span style="color: red;">*</span></label></div>
							<div class="x-row-cols " style="margin-left:2rem;">
								<input type="text" id="place" placeholder="请输入地点" />
							</div>
						</div>
	        		</li>
	        		<li>
	        			<div class="x-row" onclick="jzsj()">
							<div class="x-row-cols " style="width: 2rem;"><label>报名截止时间<span style="color: red;">*</span></label></div>
							<div class="x-row-cols " style="margin-left:2rem;">
								<input unselectable="on" onfocus="this.blur()" id="input-jzsj" type="text" readonly="readonly" placeholder="请选择报名截止时间" />
								<img class="right-arrow" src="../../img/icon-vote-2.png" />
							</div>
						</div>
	        		</li>
	        		<li>
	        			<div class="x-row" onclick="st()">
							<div class="x-row-cols " style="width: 2rem;"><label>活动开始日期<span style="color: red;">*</span></label></div>
							<div class="x-row-cols " style="margin-left:2rem;">
								<input unselectable="on" onfocus="this.blur()" id="st" type="text" readonly="readonly" placeholder="请选择活动开始日期" />
								<img class="right-arrow" src="../../img/icon-vote-2.png" />
							</div>
						</div>
	        		</li>
	        		<li>
	        			<div class="x-row" onclick="et()">
							<div class="x-row-cols " style="width: 2rem;"><label>活动结束日期<span style="color: red;">*</span></label></div>
							<div class="x-row-cols " style="margin-left:2rem;">
								<input unselectable="on" onfocus="this.blur()" id="et" type="text" readonly="readonly" placeholder="请选择活动结束日期" />
								<img class="right-arrow" src="../../img/icon-vote-2.png" />
							</div>
						</div>
	        		</li>
	        		<li>
	        			<div class="x-row" onclick="openContact()">
							<div class="x-row-cols " style="width: 2rem;"><label>活动参与人<span style="color: red;">*</span></label></div>
							<div class="x-row-cols " style="margin-left:2rem;">
								<input id="checkIds" type="hidden" />
								<input unselectable="on" onfocus="this.blur()" id="checkName" type="text" readonly="readonly" placeholder="请选择活动参与人" />
								<img class="right-arrow" src="../../img/icon-vote-2.png" />
							</div>
						</div>
	        		</li>
	        	</ul>
	        	
	        	<ul class="act3-form">
	        		<li class="noline">
	        			<div class="x-row">
							<div class="x-row-cols " style="width: 100%;"><label>封面图片<span>可上传封面图片</span></label></div>
							<input type="hidden" id="imgUrl" name="" value="" />
							<input type="hidden" id="imgName" name="" value="" />
						</div>
	        		</li>
	        		<li>
	        			<div class="x-row">
							<div class="x-row-cols " style="width: 100%;">
								<div class="imagelist ell" id="imagelist">
									<div class="imagelist-item" id="addImage">
										<div class="imagelist-item-btn">
											<input name="newsFile" id="attachment" type="file" onchange="upload('attachment')" accept="image/jpg,image/png" />
										</div>
									</div>
								</div>
							</div>
						</div>
	        		</li>
        		</ul>
        		<ul class="act3-form">
	        		<li class="noline">
	        			<div class="x-row">
							<div class="x-row-cols " style="width: 100%;"><label>活动简介<span style="color: red;">*</span></label></div>
						</div>
	        		</li>
	        		<li>
	        			<div class="x-row">
							<div class="x-row-cols " style="width: 100%;">
								<textarea id="intro" name="" rows="5" cols="" placeholder="请输入活动简介"></textarea>
							</div>
						</div>
	        		</li>
        		</ul>
	        </div>
		</div>
		
		<div class="btn" style="width: 50%;" onclick="addActivity(10);">预览</div>
		<div class="btn" style="width: 50%;left: 50%;" onclick="addActivity(0);">完成</div>
	</body>
	<script src="../../js/jquery-1.9.1.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="../../../common/js/base.js"></script>
	<script type="text/javascript" src="../../../common/js/common.js"></script>
	<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/mui.picker.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/mui.poppicker.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
	<script type="text/javascript" src="../../../../../module/backstage/commons/upload/upload.js"></script>
	<script type="text/javascript">
		var acid = Commonjs.getUrlParam("acId");
		var acUUid = '';
		var oldMemberIds = '';
		var memberIds = "";
		var memberNames = "";
		var selectedDepartmentArray=[];
		var selectedUserArray=[];
		var changePeopleFlag = false;
		$(function(){
			getWxConfig();
			if(acid != '' && acid != null && acid != undefined){
        		getActivityInfo();
        		getPeopleList(0);
        	}
		});
	
		//获取活动信息
		function getActivityInfo(){
			var apiData = {};	
    		apiData.id = acid;
    		apiData.status = -1;
     		var param = {};
     		param.apiParam = Commonjs.getApiReqParams(apiData);
     		Commonjs.ajax('/wsgw/qyWeChat/QueryActivityById/callApi.do',param,function(dd){
     			if(dd.RespCode == 10000){
     				acUUid = dd.Data[0].Activityid;
     				$("#st").val(dd.Data[0].Starttime);
     				$("#et").val(dd.Data[0].Endtime);
     				$("#place").val(dd.Data[0].Place);
     				var htmlIntro = dd.Data[0].Intro;
     				$("#intro").val($(htmlIntro).text());
     				$("#title").val(dd.Data[0].Title);
     				$("#partNumber").val(dd.Data[0].Totalnumber);
     				$("#input-jzsj").val(dd.Data[0].Expiretime);

     				if(dd.Data[0].ImgUrl != ''){
    	    			$("#imgUrl").val(dd.Data[0].ImgUrl);
    	    			$("#imgName").val(dd.Data[0].ImgName);
    					//展示图片
     					var html = [];
    			        html.push('<div class="imagelist-item" id="imagelist-item">');
    					html.push('	<div class="imagelist-item-img"><img src="'+dd.Data[0].ImgUrl+'"/></div>');
    					html.push('</div>');
    					$('#imagelist-item').remove();
    			        $('#imagelist').before(html.join(''));
    	        		$('#attachment').val(''); 
     				}   				
     				
     			}
     		},{async:false});
		}
		
		//获取参与人
		function getPeopleList(memberType){
			var apiData = {};	
            apiData.uid = acUUid;
            apiData.memberType = memberType;
    		var param = {};
    		param.apiParam = Commonjs.getApiReqParams(apiData);
    		Commonjs.ajax('/wsgw/qyWeChat/QueryToMember/callApi.do',param,function(dd){
    			if(dd.RespCode == 10000){
					var names = '';
					var ids = '';
					for(var i = 0;i<dd.Data.length; i++){
						var id = dd.Data[i].Memberid;
						if(dd.Data[i].IsDept == 1){
							selectedDepartmentArray.push(id);
							id = "d_" + id;
						}
						if(dd.Data[i].IsDept == 0){
							selectedUserArray.push(id);
						}
						names = names + dd.Data[i].Membername + ",";
						ids = ids + id + ",";
					}
			        $("#checkName").val(names.substring(0,names.length-1));
		        	$("#checkIds").val(ids.substring(0,ids.length-1));
		        	if(memberType == 0){
		        		oldMemberIds = ids.substring(0,ids.length-1);
		        	}		        	
    			}else{
					$("#checkName").val("暂无参与人");
    			}
    		},{async:false});		
		}
		
		//新增
		function addActivity(status){
			var startTime = $("#st").val();
			var endTime = $("#et").val();
			var expireTime = $("#input-jzsj").val();
			var title = $("#title").val();
			var intro = $("#intro").val();
			var totalNumber = $("#partNumber").val();
			var checksId = $("#checkIds").val();
			var place = $("#place").val();
			if(startTime == ''){
				myLayer.alert('请选择活动开始日期');
			}else if(endTime == ''){
				myLayer.alert('请选择活动结束日期');
			}else if(totalNumber == ''){
				myLayer.alert('请输入活动人数');
			}else if(place == ''){
				myLayer.alert('请填写活动地点');
			}else if(checksId == ''){
				myLayer.alert('请选择参加人员');
			}else if(expireTime == ''){
				myLayer.alert('请选择活动报名截止日期');
			}else if(title == ''){
				myLayer.alert('请填写活动主题');
			}else if(intro == ''){
				myLayer.alert('请填写活动内容');
			}else {
				var apiData = {};
    			if(acid != '' && acid != null){
    				apiData.id = acid;
    				apiData.activityId = acUUid;
    			}
	    		apiData.startTime = startTime;
	    		apiData.endTime = endTime;
	    		apiData.place = place;
	    		apiData.totalNumber = totalNumber;
	    		apiData.expireTime = expireTime;
	    		apiData.title = title;
	    		apiData.intro = intro;
	    		apiData.status = status;
	    		
	    		if($("#imgUrl").val() != ''){
	    			apiData.imgUrl = $("#imgUrl").val();
	    			apiData.imgName = $("#imgName").val();
	    		}
	    		
	     		var param = {};
	     		param.apiParam = Commonjs.getApiReqParams(apiData);
    			if(acid != '' && acid != null){
             		Commonjs.ajax('/wsgw/qyWeChat/UpdateActivity/callApi.do',param,function(dd){
                 		if(dd.RespCode == 10000){
             				if(oldMemberIds != $("#checkIds").val()){
             					changeChecksPeople(acUUid);
             				}else{
             					changePeopleFlag = true;
             				}
    	     				if(status == 0){
    	     					if(changePeopleFlag){
             						meetingPush(acUUid);
             					}
                 				myLayer.alert('活动发布成功');
                        		var url = 'index.html';
                        		location.href = Commonjs.goToUrl(url); 
    	     				}else if(status == 10){
        	     				var url = 'activityDetail.html?activityId='+acUUid+'&preview=backstage';
        	     			    location.href = Commonjs.goToUrl(url); 
        	     			}
                 		}else if(dd.RespCode == -30000 || dd.RespCode == -20000){
                 			myLayer.alert("修改失败请联系管理员！");
                 		}else if(dd.RespCode == 500){
                 			myLayer.alert("请将信息填写完整后重试！");
                 		}
             		},{async:false});
    			}else{
    	     		Commonjs.ajax('/wsgw/qyWeChat/AddActivity/callApi.do',param,function(dd){
	    	     			if(dd.RespCode == 10000){
	    	     				changeChecksPeople(dd.RespMessage);
	    	     				if(status == 0){
                 					if(changePeopleFlag){
                 						meetingPush(dd.RespMessage);
                 					}
		             				myLayer.alert("活动发布成功！");
			            			var url = 'index.html';
			            		    location.href = Commonjs.goToUrl(url); 
	    	     				}else if(status == 10){
	        	     				var url = 'activityDetail.html?activityId='+dd.RespMessage+'&preview=backstage';
	        	     			    location.href = Commonjs.goToUrl(url); 
	        	     			}
	             			}else if(dd.RespCode == -30000){
	             				myLayer.alert("申请失败请联系管理员！");
	             			}else if(dd.RespCode == 500){
	             				myLayer.alert("请将信息填写完整后重试！");
	             			}
             		},{async:false}); 
    			}
			}
		}
		
		
		//添加参与人
		function changeChecksPeople(uid){
			var apiData = {};	
            apiData.uid = uid;
            apiData.memberIds = $("#checkIds").val();
            apiData.memberNames = $("#checkName").val();
            apiData.memberType = 0;
    		var param = {};
    		param.apiParam = Commonjs.getApiReqParams(apiData);
    		Commonjs.ajax('/wsgw/qyWeChat/AddToMember/callApi.do',param,function(dd){
    			if(dd.RespCode == 10000){
    				changePeopleFlag = true;
    			}else{
    				changePeopleFlag = false;
    				myLayer.alert(dd.RespMessage,3000);
    			}
    		},{async:false});
	
		}
		
		
		//打开通讯录
		function openContact(){	
			wx.invoke("selectEnterpriseContact", {
			          "fromDepartmentId": -1,// 必填，表示打开的通讯录从指定的部门开始展示，-1表示自己所在部门开始, 0表示从最上层开始
			          "mode": "multi",// 必填，选择模式，single表示单选，multi表示多选
			          "type": ["department","user"],// 必填，选择限制类型，指定department、user中的一个或者多个
			          "selectedDepartmentIds": selectedDepartmentArray,// 非必填，已选部门ID列表。用于多次选人时可重入，single模式下请勿填入多个id
			          // 非必填，已选用户ID列表。用于多次选人时可重入，single模式下请勿填入多个id
			          "selectedUserIds": selectedUserArray 
			},function(res){
				if (res.err_msg == "selectEnterpriseContact:ok") {
					if(typeof res.result == 'string'){
						res.result = JSON.parse(res.result) //由于目前各个终端尚未完全兼容，需要开发者额外判断result类型以保证在各个终端的兼容性
			        }
					// 已选的部门列表 选择限制类型为user时无部门数据
				    selectedDepartmentList = res.result.departmentList;
				    selectedDepartmentArray = [];
				    for (var i = 0; i < selectedDepartmentList.length; i++){
				    	var department = selectedDepartmentList[i];
				        if(department!=null){
					    	var departmentId = department.id;// 已选的单个部门ID
					        var departemntName = department.name;// 已选的单个部门名称
					       
					        selectedDepartmentArray.push(departmentId);
					        memberIds += "d_"+departmentId+",";
							memberNames += departemntName+",";
					    }
				    } 
				    
				    selectedUserList = res.result.userList; // 已选的成员列表
				    selectedUserArray = [];
				    for (var i = 0; i < selectedUserList.length; i++){
				    	var user = selectedUserList[i];
				        if(user!=null){
				        	var userId = user.id; // 已选的单个成员ID
					    	var userName = user.name;// 已选的单个成员名称
					   	 	//var userAvatar= user.avatar;// 已选的单个成员头像
	                        selectedUserArray.push(userId);
	                        memberIds += userId+",";
							memberNames += userName+",";
	                    }
				    }
				    memberNames = memberNames.substr(0, memberNames.length-1);
				    //$("#parter").val(memberNames);
					$("#checkName").val(memberNames);
					$("#checkIds").val(memberIds);
		        	memberIds = "";
					memberNames = "";
				}
			});
		}
		
		//获取微信配置	
		function getWxConfig(wxkey){
			var apiData = {};	
			apiData.url = location.href.split('#')[0];
			//apiData.wxkey = wxkey;
			var param = {};
			param.apiParam = Commonjs.getApiReqParams(apiData);
			Commonjs.ajax('../../../../../wsgw/qyWeChat/GetQyWxConfigInfo/callApi.do',param,function(dd){
				if(dd.RespCode==10000){
					var data = JSON.parse(dd.RespMessage);
					wx.config({
					    beta: true,// 必须这么写，否则wx.invoke调用形式的jsapi会有问题
					    debug: false, // 开启调试模式,调用的所有api的返回值会在客户端myLayer.alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
					    appId: data.appId, // 必填，企业微信的corpID
					    timestamp: data.timestamp, // 必填，生成签名的时间戳
					    nonceStr: data.nonceStr, // 必填，生成签名的随机串
					    signature: data.signature,// 必填，签名，见 附录-JS-SDK使用权限签名算法
					    jsApiList: [
							    'selectEnterpriseContact',
						    	'chooseImage',
						    	'uploadImage',
						    	'previewImage'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
					});
				}else{
					myLayer.alert("获取企业微信配置异常！");
				}
			},{async:false});
		}
		
	
		function jzsj(){
			var inputjzsj = $('#input-jzsj');
			var dtpicker = new mui.DtPicker({
			    type: "date",//设置日历初始视图模式 
			   // beginDate: new Date(2018, 01, 01),//设置开始日期 
			    //endDate: new Date(2024, 12, 12),//设置结束日期 
			    value: inputjzsj.val(),//设置默认标签区域提示语 
			}) 
			dtpicker.show(function(e) {
			    inputjzsj.val(e.value);
			})
		}
		
		function st(){
			var st = $('#st');
			var dtpicker = new mui.DtPicker({
			    type: "date",//设置日历初始视图模式 
			    //beginDate: new Date(2018, 01, 01),//设置开始日期 
			    //endDate: new Date(2024, 12, 12),//设置结束日期 
			    value: st.val(),//设置默认标签区域提示语 
			}) 
			dtpicker.show(function(e) {

			    st.val(e.value);
			})
		}
		
		function et(){
			var et = $('#et');
			var dtpicker = new mui.DtPicker({
			    type: "date",//设置日历初始视图模式 
			    //beginDate: new Date(2018, 01, 01),//设置开始日期 
			    //endDate: new Date(2024, 12, 12),//设置结束日期 
			    value: et.val(),//设置默认标签区域提示语 
			}) 
			dtpicker.show(function(e) {
			    et.val(e.value);
			})
		}
		
		//上传图片
        function upload(id) {
			var filePath = $("#"+id).val();
			var type = filePath.substring(filePath.lastIndexOf('.')+1,filePath.length);
			var filename = filePath.substring(filePath.lastIndexOf('\\')+1,filePath.length);
			if(type.toLowerCase() != 'jpg' && type.toLowerCase() != 'png'){
				myLayer.alert('图片格式必须为.jpg或.png');
				return ;
			}
	        var arrID = [ id ];
			$.yihuUpload.ajaxFileUpload( {
				url : '../../../../../../upload/uploadFile.do', // 用于文件上传的服务器端请求地址
				secureuri : false,// 一般设置为false
				fileElementId : arrID,// 文件上传空间的id属性 <input type="file" id="file" name="file" />
				data: 'token='+Commonjs.getToken(),						
				dataType : 'json',// 返回值类型 一般设置为json
				success : function(data, status) {
					var uri = data.url;
					var uri_target = location.protocol + '//' + location.host +"/"+uri;
					var uri_target_type = uri_target.substring(uri_target.lastIndexOf('.'),uri_target.length).toLowerCase();
					uri_target = uri_target.substring(0,uri_target.lastIndexOf('.')) + uri_target_type;
					//展示图片
					var html = [];
			        html.push('<div class="imagelist-item" id="imagelist-item">');
					html.push('	<div class="imagelist-item-img"><img src="'+uri_target+'"/></div>');
					html.push('</div>');
					$('#imagelist-item').remove();
			        $('#imagelist').before(html.join(''));
	        		$('#attachment').val('');
					//保存文件名和URL
					$("#imgUrl").val(uri_target);
					$("#imgName").val(filename);
				},
				error : function(data, status, e) {
					myLayer.alert("图片上传失败：建议您选择不超过1M的图片且在良好的网络环境下继续上传",3000);
				}
			});
        }
		
		//消息推送
		function meetingPush(uid){
			var checksId = $("#checkIds").val();
			var apiData = {};	
            apiData.uid = uid;
            apiData.memberIds = checksId;
            apiData.type = 0;
    		apiData.qyClientId=Commonjs.getQyWeChatClientId();
			apiData.qyConfigKey=Commonjs.getQyWeChatConfigKey('HDYQ');
    		var param = {};
    		param.apiParam = Commonjs.getApiReqParams(apiData);
    		console.log(apiData);
    		Commonjs.ajax('/wsgw/qyWeChat/ActivityMeetingPush/callApi.do',param,function(dd){
    			if(dd.RespCode == 10000){
					
    			}else{
    				myLayer.alert(dd.RespMessage,3000);
    			}
    		},{async:false});
		}
	</script>
</html>